.rain-effect {
  position: absolute;
  inset: 0;
  pointer-events: none;
  z-index: 2; // over clouds, below lightning (render order keeps lightning on top)
  // sin máscara para cubrir todo el ancho de la ventana

  &__layer {
    position: absolute;
    inset: -10%; // extend to avoid edge gaps during animation
    background-image: repeating-linear-gradient(
      var(--rain-angle, 95deg),
      hsl(var(--foreground) / var(--rain-alpha, 0.25)) 0,
      hsl(var(--foreground) / var(--rain-alpha, 0.25)) var(--rain-thickness, 1px),
      transparent var(--rain-spacing, 6px)
    );
    background-size: 200% 200%;
    background-position: 0 0;
    animation:
      rain-fall-diagonal var(--rain-duration, 900ms)
        var(--rain-timing, cubic-bezier(0.22, 0.61, 0.36, 1)) infinite,
      rain-soft var(--rain-soft-duration, 6s) ease-in-out infinite;
    opacity: calc(var(--layer-opacity, 0.4) * var(--rain-global-opacity, 1));
    filter: blur(var(--rain-blur, 0px));
    mix-blend-mode: soft-light;
    will-change: background-position, opacity;
  }

  &__layer--far {
    --layer-opacity: 0.2;
    --rain-thickness: 1px;
    --rain-spacing: 8px;
    --rain-blur: 0.4px;
    --rain-alpha: 0.22;
  }

  &__layer--mid {
    --layer-opacity: 0.25;
    --rain-thickness: 1.1px;
    --rain-spacing: 9px;
    --rain-blur: 0.2px;
    --rain-alpha: 0.26;
  }

  &__layer--near {
    --layer-opacity: 0.3;
    --rain-thickness: 1.4px;
    --rain-spacing: 10px;
    --rain-blur: 0px;
    --rain-alpha: 0.3;
  }

  // soft mist to blend heavy rain and integrate with fog/snow
  &__mist {
    position: absolute;
    inset: 0;
    pointer-events: none;
    background:
      radial-gradient(120% 80% at 50% 10%, hsl(var(--foreground) / 0.025) 0%, transparent 60%),
      radial-gradient(140% 100% at 50% 100%, hsl(var(--foreground) / 0.03) 0%, transparent 70%);
    opacity: calc(var(--mist-opacity, 0) * var(--rain-global-opacity, 1));
    mix-blend-mode: soft-light;
    transition: opacity 400ms ease-out;
  }

  // Discrete drops container
  &__drops {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }

  // Single drop
  &__drop {
    position: absolute;
    left: 0;
    top: -10vh;
    width: 0;
    height: var(--length, 18px);
    /* El cuerpo real de la gota se construye con pseudo-elementos para cabeza + estela */
    &::before,
    &::after {
      content: "";
      position: absolute;
      left: calc(var(--head-w, calc(var(--thickness, 1px) * 1.5)) * -0.5);
      width: var(--head-w, calc(var(--thickness, 1px) * 1.5));
      border-radius: 9999px;
      pointer-events: none;
    }
    /* cabeza brillante */
    &::before {
      top: 0;
      height: calc(var(--length, 18px) * 0.2);
      background: radial-gradient(
        ellipse at 50% 35%,
        hsl(var(--foreground) / calc(var(--alpha, 0.28) * 1.4)) 0%,
        hsl(var(--foreground) / calc(var(--alpha, 0.28) * 0.2)) 45%,
        transparent 70%
      );
      filter: blur(0.2px) drop-shadow(0 0 1px hsl(var(--foreground) / 0.15));
    }
    /* estela difuminada */
    &::after {
      top: calc(var(--length, 18px) * 0.12);
      height: calc(var(--length, 18px) * 0.88);
      background: linear-gradient(
        to bottom,
        hsl(var(--foreground) / calc(var(--alpha, 0.28) * 0.95)) 0%,
        hsl(var(--foreground) / calc(var(--alpha, 0.28) * 0.5)) 55%,
        transparent 100%
      );
      /* Estrecha levemente la estela para un efecto más "afilado" */
      clip-path: polygon(50% 0, 64% 100%, 36% 100%);
      filter: blur(0.2px);
    }
    transform: translate3d(0, 0, 0) rotate(var(--angle, 82deg));
    transform-origin: top center;
    animation:
      rain-drop-fall var(--duration, 1100ms) linear var(--delay, 0s) infinite,
      drop-fade var(--duration, 1100ms) linear var(--delay, 0s) infinite;
    opacity: calc(var(--opacity, 0.55) * var(--rain-global-opacity, 1));
    filter: blur(var(--blur, 0px));
    mix-blend-mode: overlay;
    will-change: transform, opacity;
  }

  // Snowflake element
  &__flake {
    position: absolute;
    left: 0;
    top: -10vh;
    width: var(--size, 3px);
    height: var(--size, 3px);
    background: radial-gradient(
      circle,
      hsl(var(--foreground) / var(--alpha, 0.4)) 0%,
      transparent 70%
    );
    border-radius: 9999px;
    filter: blur(var(--blur, 0.6px));
    animation:
      snow-flake-fall var(--duration, 3500ms) linear var(--delay, 0s) infinite,
      drop-fade var(--duration, 3500ms) linear var(--delay, 0s) infinite;
    opacity: calc(var(--opacity, 0.7) * var(--rain-global-opacity, 1));
    mix-blend-mode: soft-light;
    will-change: transform, opacity;
  }
}

@keyframes rain-fall {
  0% {
    background-position: 0 0;
  }
  100% {
    background-position: 0 100%;
  }
}

// diagonal fall with horizontal drift controlled by --rain-shift-x
@keyframes rain-fall-diagonal {
  0% {
    background-position: 0 0;
  }
  100% {
    background-position: var(--rain-shift-x, 50%) 100%;
  }
}

@keyframes rain-drop-fall {
  0% {
    transform: translate3d(0, -20vh, 0) rotate(var(--angle, 82deg));
  }
  100% {
    transform: translate3d(var(--drift-x, 8vw), 120vh, 0) rotate(var(--angle, 82deg));
  }
}

@keyframes snow-flake-fall {
  0% {
    transform: translate3d(0, -20vh, 0);
  }
  100% {
    transform: translate3d(var(--drift-x, 6vw), 120vh, 0);
  }
}

// keep visible until ~90%, then fade to 0
@keyframes drop-fade {
  0%,
  90% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}

@keyframes rain-soft {
  0%,
  100% {
    opacity: 0.95;
  }
  50% {
    opacity: 1;
  }
}
